<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="costa@tsaousis.gr">
 
 	<title>NetData</title>

	<!-- Google AJAX API -->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<link href="/file/theme.css" rel="stylesheet">

	<!-- NetData -->
	<script type="text/javascript" src="/file/netdata.js"></script>
	<script type="text/javascript" src="/file/jquery.visible.js"></script>
	<script type="text/javascript">
	
	// Set a callback to run when the Google Visualization API is loaded.
	google.setOnLoadCallback(initCharts);
	
	var MODE_THUMBS = 1;
	var MODE_MAIN = 2;
	var mode; // one of the MODE_* values

	var mycharts = new Array();
	var mainchart;

	function chartIsLoadingHTML(width, height) { return "<table><tr><td align=\"center\" width=\"" + width + "\" height=\"" + height + "\"><h4><span class=\"glyphicon glyphicon-refresh\"></span><br/><br/>loading chart<br/><br/><span class=\"label label-default\">Please wait...</span></h4></td></tr></table>"; }

	function showChartIsLoading(id, width, height) { document.getElementById(id).innerHTML = chartIsLoadingHTML(width, height); }

	// copy the chart c to mainchart
	// switch to main graphs screen
	function mainChart(c) {
		if(mainchart && mainchart.chart) mainchart.chart.clearChart();

		mainchart = $.extend(true, {}, c);

		mainchart.chart = null;
		mainchart.chartOptions.width = Math.round((($(window).width() * 0.95) - 50) / 1);
		mainchart.chartOptions.height = $(window).height() - 200;
		if(mainchart.chartOptions.height < 300) mainchart.chartOptions.height = 300;
		
		mainchart.thumbnail = false;
		mainchart.group = 5;
		mainchart.group_method = "max";
		mainchart.div = 'maingraph';
		mainchart.last_updated = 0;
		mainchart.explorer = false;

		if(mainchart.type == "tc") {
			mainchart.group = 15;
			mainchart.group_method = "average";
		}
		else if(mainchart.type == "ipv4" || mainchart.type == "conntrack" || mainchart.type == "ipvs") {
			mainchart.group = 15;
			mainchart.group_method = "max";
		}

		// calculate the time to refresh each chart
		mainchart.chart_update_every = mainchart.group * 1000; // milliseconds

		// calculate how many point to show for each chart
		mainchart.points_to_show = Math.round(mainchart.entries / mainchart.group) - 1;

		// show max 10 mins of data
		if(mainchart.points_to_show * mainchart.group > 1200) mainchart.points_to_show = 1200 / mainchart.group;

		// initialize the div
		showChartIsLoading(mainchart.div, mainchart.chartOptions.width, mainchart.chartOptions.height);

		document.getElementById('maingraph_title').innerHTML = " <b> " + mainchart.title + " </b> (as " + mainchart.group_method + " of every " + (mainchart.group * mainchart.update_every) + " seconds)";

		showMainGraph();
	}

	function setMainChart(i) {
		mainChart(mycharts[i]);
	}

	// refresh the main chart
	// make sure it gets updated frequently
	function mainChartRefresh() {
		if(!mainchart || mode != MODE_MAIN) {
			if(mainchart) mainchart.clearChart();
			showThumbGraphs();
			return;
		}

		var now = new Date().getTime();

		if((now - mainchart.last_updated) >= mainchart.chart_update_every) {
			refreshChart(mainchart, triggerMainChartRefresh);
			mainchart.last_updated = now;
		}
		else triggerMainChartRefresh();
	}

	// callback for refreshing the main chart
	function triggerMainChartRefresh() {
		if(mode == MODE_MAIN) setTimeout(mainChartRefresh, 500);
	}

	// calculate the proper width for the thumb charts
	function thumbWidth() {
		var items = Math.round((($(window).width() * 0.95) - 50) / 500);
		if(items < 1) items = 1;

		var width = Math.round((($(window).width() * 0.95) - 50) / items) - 1;
		//console.log("window = " + (($(window).width() * 0.95) - 50) + ", items = " + items + ", width = " + width);

		return width;
	}

	// resize all charts
	// if the thumb charts need resize in their width, reset them
	function resizeCharts() {
		var width = Math.round((($(window).width() * 0.95) - 50) / 1);
		if(mainchart) {
			mainchart.chartOptions.width = Math.round((($(window).width() * 0.95) - 50) / 1);
			mainchart.chartOptions.height = $(window).height() - 200;
			mainchart.last_updated = 0;
		}

		width = thumbWidth();
		$.each(mycharts, function(i, c) {
			if(c.enabled && c.chartOptions.width != width) {
				if(c.chart) c.chart.clearChart();
				c.chart = null;
				c.chartOptions.width = width;
				showChartIsLoading(c.div, c.chartOptions.width, c.chartOptions.height);
				c.last_updated = 0;
			}
		});
	}

	// load the charts from the server
	// generate html for the thumbgraphs to support them
	function initCharts() {
		var width = thumbWidth();
		var height = 200;

		loadCharts(function(c) {
			mycharts = c;

			if(mycharts == null || mycharts.length == 0) {
				alert("Cannot load data from server.");
				return;
			}

			var thumbsContainer = document.getElementById("graphs");
			if(!thumbsContainer) {
				alert("Cannot find the thumbsContainer");
				return;
			}

			function chartssort(a, b) {
				if(a.userpriority < b.userpriority) return -1;
				return 1;
			}
			mycharts.sort(chartssort);

			document.getElementById('hostname_id').innerHTML = mycharts[0].hostname;
			document.title = mycharts[0].hostname;

			// create an array for grouping all same-type graphs together
			var categories = new Array();
			$.each(mycharts, function(i, c) {
				c.last_updated = 0;
				c.chartOptions.width = width;
				c.chartOptions.height = height;

				switch(c.type) {
					case "tc":
						c.glyphicon = "glyphicon-transfer";
						c.group = 30;
						c.group_method = "average";
						break;

					case "net":
						c.glyphicon = "glyphicon-cloud";
						c.group = 10;
						c.group_method = "max";
						break;

					case "ipv4":
						c.glyphicon = "glyphicon-resize-full";
						c.group = 30;
						c.group_method = "max";
						break;

					case "conntrack":
						c.glyphicon = "glyphicon-eye-open";
						c.group = 30;
						c.group_method = "max";
						break;

					case "ipvs":
						c.glyphicon = "glyphicon-sort";
						c.group = 30;
						c.group_method = "max";
						break;

					case "disk":
						c.glyphicon = "glyphicon-floppy-disk";
						c.group = 20;
						c.group_method = "max";
						break;

					default:
						c.glyphicon = "glyphicon-search";
						c.group = 60;
						c.group_method = "max";
						break;
				}

				// calculate the time to refresh each chart
				c.chart_update_every = c.group * 1000; // milliseconds

				// calculate how many point to show for each chart
				c.points_to_show = Math.round(c.entries / c.group) - 1;

				// show max 10 mins of data
				if(c.points_to_show * c.group > 600) c.points_to_show = 600 / c.group;

				if(c.enabled) {
					var j;
					var h = "<div class=\"thumbgraph\"><table><tr><td><div class=\"thumbgraph\" id=\"" + c.div + "\">" + chartIsLoadingHTML(c.chartOptions.width, c.chartOptions.height) + "</div></td></tr><tr><td align=\"center\"><div class=\"btn-group-xs\"><button type=\"button\" class=\"btn btn-default\" onclick=\"setMainChart(" + i +");\">&nbsp;&nbsp;select " + c.name + " for zoom&nbsp;&nbsp;</button></div></td></tr></table></div>";

					// find the categories object for this type
					for(j = 0; j < categories.length ;j++) {
						if(categories[j].name == c.type) {
							categories[j].html += h;
							categories[j].count++;
							break;
						}
					}

					if(j == categories.length) {
						var t = "(as " + c.group_method + " every " + (c.group*c.update_every) + " seconds)";
						categories.push({name: c.type, title: c.category, description: t, priority: 0, count: 1, glyphicon: c.glyphicon, html: h});
					}
				}
			});

			$.each(categories, function(i, a) {
				     if(a.name == "net") a.priority = 1;
				else if(a.name == "tc") a.priority = 2;
				else if(a.name == "conntrack") a.priority = 3;
				else if(a.name == "ipvs") a.priority = 4;
				else if(a.name == "ipv4") a.priority = 5;
				else if(a.name == "disk") a.priority = 6;
				else a.priority = 4;

				a.html = "<tr><td><ol class=\"breadcrumb graphs\"><li class=\"active\"><span class=\"glyphicon " + a.glyphicon + "\"></span> &nbsp; <a id=\"" + a.name + "\" href=\"#" + a.name + "\"><b>" + a.title + "</b> " + a.description + " </a></li></ol></td></tr><tr><td><div class=\"thumbgraphs\">" + a.html + "</td></tr>";
			});

			function categoriessort(a, b) {
				if(a.priority < b.priority) return -1;
				return 1;
			}
			categories.sort(categoriessort);

			// combine all the htmls into one
			var allcategories = "<table width=\"100%\">";
			$.each(categories, function(i, a) {
				allcategories += a.html;
			});
			allcategories += "</table>";

			thumbsContainer.innerHTML = allcategories;
			showThumbGraphs();
		});
	}

	var last_mini = 0;
	function thumbChartsRefreshInternal(howmany) {
		if(mycharts.length == 0 || mode != MODE_THUMBS) return;

		var now = new Date().getTime();

		// refresh the mini charts
		var wanted = howmany;
		var did    = 0;
		var count  = mycharts.length - 1;
		while(did < wanted && count >= 0) {
			count--;
			last_mini++;
			if(last_mini >= mycharts.length) last_mini = 0;

			if(!mycharts[last_mini].enabled) continue;
			if((now - mycharts[last_mini].last_updated) < mycharts[last_mini].chart_update_every) continue;

			if(mycharts[last_mini].chart != null)
				if(mycharts[last_mini].chart.getSelection()[0]) continue;

			if($('#' + mycharts[last_mini].div).visible(true) == false) continue;

			refreshChart(mycharts[last_mini], triggerThumbChartsRefreshFast);
			mycharts[last_mini].last_updated = now;

			did++;
		}

		if(did == 0) triggerThumbChartsRefresh();
	}

	function triggerThumbChartsRefresh() {
		setTimeout(thumbChartsRefresh, 200);
	}

	function triggerThumbChartsRefreshFast() {
		thumbChartsRefresh();
	}

	function thumbChartsRefresh() {
		if(mode == MODE_THUMBS) thumbChartsRefreshInternal(1);
	}

	// setInterval(myChartsRefresh, 500);

	window.onresize = function(event) {
		resizeCharts();
	};

	function showMainGraph() {
		if(!mainchart) return;
		mode = MODE_MAIN;

		document.getElementById('maingraph_container').style.display = 'block';
		document.getElementById('thumbgraphs_container').style.display = 'none';

		mainChartRefresh();
	}

	function showThumbGraphs() {
		mode = MODE_THUMBS;

		document.getElementById('maingraph_container').style.display = 'none';
		document.getElementById('thumbgraphs_container').style.display = 'block';

		if(mainchart) {
			if(mainchart.chart) mainchart.chart.clearChart();
			mainchart = null;
		}

		thumbChartsRefresh(1);
	}

	</script>
</head>

<body role="document">
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" id="hostname_id">NetData</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#net">Network</a></li>
            <li><a href="#tc">QoS</a></li>
            <li><a href="#conntrack">Netfilter</a></li>
            <li><a href="#ipv4">IPv4</a></li>
            <li><a href="#ipvs">IPVS</a></li>
            <li><a href="#disk">Disk</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container graphs" id="maingraph_container" style="display: none">
		<table>
			<tr><td><ol class="breadcrumb graphs"><li class="active"><a id="maingraph_title" href="#maingraph"><b> Maingraph </b></a></li></ol></td></tr>
			<tr><td>
		    	<div class="maingraph">
					<table>
						<tr><td><div class="maingraph" id="maingraph"></div></td></tr>
						<tr><td align="center"><div class="btn-group"><button type="button" onclick="showThumbGraphs();" class="btn btn-default"> close main graph </button></div></td></tr>
					</table>
		 	   </div><!-- /.maingraph -->
			</td></tr>
		</table>
	</div>

    <div class="container graphs" id="thumbgraphs_container">
    	<div class="allgraphs" id="graphs">
    	<table width="100%"><tr><td align="center"><p/>&nbsp;<p/>&nbsp;<p/>&nbsp;<h1><span class="glyphicon glyphicon-refresh"></span><br/><br/>loading charts<br/><br/><span class="label label-default">Please wait...</span></h1></td></tr></table>
    	</div>
	</div>
</html>
