<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="">
    <meta name="author" content="costa@tsaousis.gr">
 
 	<title>NetData</title>

	<!-- Google AJAX API -->
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<link href="/file/theme.css" rel="stylesheet">

	<!-- NetData -->
	<script type="text/javascript" src="/file/netdata.js"></script>
	<script type="text/javascript" src="/file/jquery.visible.js"></script>
	<script type="text/javascript">
	
	// Set a callback to run when the Google Visualization API is loaded.
	google.setOnLoadCallback(initCharts);
	
	var TARGET_THUMB_GRAPH_WIDTH = 500; // chart width will range from 0.5 to 1.5 of that
	var MINIMUM_THUMB_GRAPH_WIDTH = 400; // chart will generally try to be wider than that
	var TARGET_THUMB_GRAPH_HEIGHT = 220;

	var MODE_THUMBS = 1;
	var MODE_MAIN = 2;
	var mode; // one of the MODE_* values

	var mycharts = new Array();
	var mainchart;

	function chartIsLoadingHTML(width, height) { return "<table><tr><td align=\"center\" width=\"" + width + "\" height=\"" + height + "\" style=\"vertical-align:middle\"><h4><span class=\"glyphicon glyphicon-refresh\"></span><br/><br/>loading chart<br/><br/><span class=\"label label-default\">Please wait...</span></h4></td></tr></table>"; }

	function showChartIsLoading(id, width, height) { document.getElementById(id).innerHTML = chartIsLoadingHTML(width, height); }

	// copy the chart c to mainchart
	// switch to main graphs screen
	function mainChart(c) {
		if(mainchart && mainchart.chart) mainchart.chart.clearChart();

		mainchart = $.extend(true, {}, c);

		mainchart.chart = null;
		mainchart.chartOptions.width = screenWidth();
		mainchart.chartOptions.height = $(window).height() - 200;
		if(mainchart.chartOptions.height < 300) mainchart.chartOptions.height = 300;
		
		mainchart.thumbnail = false;
		mainchart.group = 5;
		mainchart.div = 'maingraph';
		mainchart.last_updated = 0;
		mainchart.explorer = false;

		if(mainchart.chartOptions.isStacked) mainchart.group = 15;

		// calculate how many point to show for each chart
		mainchart.points_to_show = Math.round(mainchart.entries / mainchart.group) - 1;

		// show max 10 mins of data
		if(mainchart.points_to_show * mainchart.group > 1200) mainchart.points_to_show = 1200 / mainchart.group;

		// initialize the div
		showChartIsLoading(mainchart.div, mainchart.chartOptions.width, mainchart.chartOptions.height);

		document.getElementById('maingraph_title').innerHTML = " <b> " + mainchart.title + " </b> (as " + mainchart.group_method + " of every " + (mainchart.group * mainchart.update_every) + " seconds)";

		showMainGraph();
	}

	function setMainChart(i) {
		mainChart(mycharts[i]);
	}

	// refresh the main chart
	// make sure it gets updated frequently
	function mainChartRefresh() {
		if(!mainchart || mode != MODE_MAIN) {
			if(mainchart) mainchart.clearChart();
			showThumbGraphs();
			return;
		}

		if(!refreshChart(mainchart, triggerRefresh)) triggerRefresh();
	}

	function screenWidth() {
		return (($(window).width() * 0.95) - 40);
	}

	// calculate the proper width for the thumb charts
	function thumbWidth() {
		var cwidth = screenWidth();
		var items = Math.round(cwidth / TARGET_THUMB_GRAPH_WIDTH);
		if(items < 1) items = 1;

		if(items > 1 && (cwidth / items) < MINIMUM_THUMB_GRAPH_WIDTH) items--;

		return Math.round(cwidth / items) - 1;
	}

	// resize all charts
	// if the thumb charts need resize in their width, reset them
	function resizeCharts() {
		var width = screenWidth();

		if(mainchart) {
			mainchart.chartOptions.width = width;
			mainchart.chartOptions.height = $(window).height() - 200;
			mainchart.last_updated = 0;
		}

		width = thumbWidth();
		$.each(mycharts, function(i, c) {
			if(c.enabled && c.chartOptions.width != width) {
				if(c.chart) c.chart.clearChart();
				c.chart = null;
				c.chartOptions.width = width;
				showChartIsLoading(c.div, c.chartOptions.width, c.chartOptions.height);
				c.last_updated = 0;
			}
		});
	}

	// load the charts from the server
	// generate html for the thumbgraphs to support them
	function initCharts() {
		var width = thumbWidth();
		var height = TARGET_THUMB_GRAPH_HEIGHT;

		loadCharts(function(c) {
			mycharts = c;

			if(mycharts == null || mycharts.length == 0) {
				alert("Cannot load data from server.");
				return;
			}

			var thumbsContainer = document.getElementById("thumbgraphs");
			if(!thumbsContainer) {
				alert("Cannot find the thumbsContainer");
				return;
			}

			function chartssort(a, b) {
				if(a.userpriority < b.userpriority) return -1;
				return 1;
			}
			mycharts.sort(chartssort);

			document.getElementById('hostname_id').innerHTML = mycharts[0].hostname;
			document.title = mycharts[0].hostname;

			// create an array for grouping all same-type graphs together
			var categories = new Array();
			$.each(mycharts, function(i, c) {
				c.chartOptions.width = width;
				c.chartOptions.height = height;

				// calculate how many point to show for each chart
				c.points_to_show = Math.round(c.entries / c.group) - 1;

				// show max 10 mins of data
				if(c.points_to_show * c.group > 600) c.points_to_show = 600 / c.group;

				if(c.enabled) {
					var j;
					var h = "<div class=\"thumbgraph\"><table><tr><td><div class=\"thumbgraph\" id=\"" + c.div + "\">" + chartIsLoadingHTML(c.chartOptions.width, c.chartOptions.height) + "</div></td></tr><tr><td align=\"center\"><div class=\"btn-group-xs\"><button type=\"button\" class=\"btn btn-default\" onclick=\"setMainChart(" + i +");\">&nbsp;&nbsp;select " + c.name + " for zoom&nbsp;&nbsp;</button></div></td></tr></table></div>";

					// find the categories object for this type
					for(j = 0; j < categories.length ;j++) {
						if(categories[j].name == c.type) {
							categories[j].html += h;
							categories[j].count++;
							break;
						}
					}

					if(j == categories.length) {
						var t = "(as " + c.group_method + " every " + (c.group * c.update_every) + " seconds)";
						categories.push({name: c.type, title: c.category, description: t, priority: 0, count: 1, glyphicon: c.glyphicon, html: h});
					}
				}
			});

			$.each(categories, function(i, a) {
				     if(a.name == "net") a.priority = 1;
				else if(a.name == "tc") a.priority = 2;
				else if(a.name == "conntrack") a.priority = 3;
				else if(a.name == "ipvs") a.priority = 4;
				else if(a.name == "ipv4") a.priority = 5;
				else if(a.name == "cpu") a.priority = 6;
				else if(a.name == "disk") a.priority = 7;
				else a.priority = 99;

				a.html = "<tr><td><ol class=\"breadcrumb graphs\"><li class=\"active\"><span class=\"glyphicon " + a.glyphicon + "\"></span> &nbsp; <a id=\"" + a.name + "\" href=\"#" + a.name + "\"><b>" + a.title + "</b> " + a.description + " </a></li></ol></td></tr><tr><td><div class=\"thumbgraphs\">" + a.html + "</td></tr>";
			});

			function categoriessort(a, b) {
				if(a.priority < b.priority) return -1;
				return 1;
			}
			categories.sort(categoriessort);

			// combine all the htmls into one
			var allcategories = "<table width=\"100%\">";
			$.each(categories, function(i, a) {
				allcategories += a.html;
			});
			allcategories += "</table>";

			thumbsContainer.innerHTML = allcategories;
			showThumbGraphs();
		});
	}

	var last_thumb_updated = 0;
	function thumbChartsRefresh() {
		if(mycharts.length == 0 || mode != MODE_THUMBS) return;

		// find a chart to refresh
		var orig = last_thumb_updated;
		last_thumb_updated++;
		if(last_thumb_updated >= mycharts.length) last_thumb_updated = 0;

		while(last_thumb_updated != orig) {
			if(refreshChart(mycharts[last_thumb_updated], chartsRefresh)) break;

			last_thumb_updated++;
			if(last_thumb_updated >= mycharts.length) last_thumb_updated = 0;
		}

		// no chart refreshed
		if(last_thumb_updated == orig)
			triggerRefresh();
	}

	// refresh the proper chart
	function chartsRefresh() {
		if(mode == MODE_THUMBS)
			thumbChartsRefresh();

		else if(mode == MODE_MAIN)
			mainChartRefresh();

		else
			setTimeout(triggerRefresh, 1000);
	}

	// callback for refreshing the charts later
	function triggerRefresh() {
		if(mode == MODE_THUMBS)
			setTimeout(thumbChartsRefresh, 200);

		else if(mode == MODE_MAIN)
			setTimeout(mainChartRefresh, 500);

		else
			setTimeout(triggerRefresh, 1000);
	}

	window.onresize = function(event) {
		resizeCharts();
	};

	var thumbsScrollPosition = null;
	function showMainGraph() {
		if(!mainchart) return;

		thumbsScrollPosition = window.pageYOffset;

		mode = MODE_MAIN;

		document.getElementById('maingraph_container').style.display = 'block';
		document.getElementById('thumbgraphs_container').style.display = 'none';

		chartsRefresh();
	}

	function showThumbGraphs() {
		mode = MODE_THUMBS;

		document.getElementById('maingraph_container').style.display = 'none';
		document.getElementById('thumbgraphs_container').style.display = 'block';

		if(thumbsScrollPosition) window.scrollTo(0, thumbsScrollPosition);

		if(mainchart) {
			if(mainchart.chart) mainchart.chart.clearChart();
			mainchart = null;
		}

		chartsRefresh();
	}

	</script>
</head>

<body role="document">
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" id="hostname_id">NetData</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#net">Network</a></li>
            <li><a href="#tc">QoS</a></li>
            <li><a href="#conntrack">Netfilter</a></li>
            <li><a href="#ipv4">IPv4</a></li>
            <li><a href="#ipvs">IPVS</a></li>
            <li><a href="#disk">Disk</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container graphs" id="maingraph_container" style="display: none">
		<table>
			<tr><td><ol class="breadcrumb graphs"><li class="active"><a id="maingraph_title" href="#maingraph"><b> Maingraph </b></a></li></ol></td></tr>
			<tr><td>
		    	<div class="maingraph">
					<table>
						<tr><td><div class="maingraph" id="maingraph"></div></td></tr>
						<tr><td align="center"><div class="btn-group"><button type="button" onclick="showThumbGraphs();" class="btn btn-default"> close main graph </button></div></td></tr>
					</table>
		 	   </div><!-- /.maingraph -->
			</td></tr>
		</table>
	</div>

    <div class="container graphs" id="thumbgraphs_container">
    	<div class="allgraphs" id="thumbgraphs">
    		<table width="100%">
    			<tr><td id="splash" align="center" style="vertical-align:middle">
    				<h1>
    				Welcome to <b>NetData</b>!
    				<br/><br/>
    				<span class="glyphicon glyphicon-off"></span>
    				<br/><br/>
    				loading charts
    				<br/><br/>
    				<span class="label label-default">Please wait...</span>
    				</h1>
    			</td></tr>
    		</table>
    	</div>
	</div>

	<script type="text/javascript">document.getElementById('splash').height = $(window).height();</script>
</html>
