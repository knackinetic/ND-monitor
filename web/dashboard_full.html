<!DOCTYPE html>
<html lang="en">
<head>
	<title>NetData Dashboard</title>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="author" content="costa@tsaousis.gr">
<style>
body {
 padding-top:50px;
}

#masthead h1 {
 /*font-size: 30px;*/
 line-height: 1;
 padding-top:20px;
}

#masthead .well {
 margin-top:4%;
}

#sidebar li.active {
  border:0 #eee solid;
  border-right-width:5px;
}

@media (min-width: 979px) {
  #sidebar.affix-top {
    position: static;
  	margin-top:30px;
  	width:228px;
  }
  
  #sidebar.affix {
    position: fixed;
    top:70px;
    width:228px;
  }
}
</style>
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="banner">
		<div class="container">
			<div class="navbar-header">
				<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a href="/" class="navbar-brand">Netdata</a>
			</div>
			<nav class="collapse navbar-collapse" role="navigation">
				<ul class="nav navbar-nav">
					<li><a href="#sec">Get Started</a></li>
					<li><a href="#sec">Edit</a></li>
					<li><a href="#sec">Visualize</a></li>
					<li><a href="#sec">Prototype</a></li>
				</ul>
			</nav>
		</div>
	</nav>

	<div id="masthead"> 
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<h1>Netdata Dashboard
						<p class="lead">Real time data collection and graphs...</p>
					</h1>
				</div>
				<div class="col-md-6">
					<div class="well well-lg">
						<div class="row">
							<div class="col-sm-6">
								<div data-netdata="system.cpu" data-chart-library="dygraph" data-dygraph-theme="sparkline" data-before="0" data-after="-60" data-width="100%" data-height="60px"></div>
							</div>
							<div class="col-sm-6">
								Drag charts to pan.<br/>
								Shift + wheel on them, to zoom.</br>
								Double-click on them, to reset.
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-md-10" role="main">
				<div id="charts_div"></div>
			</div>
			<div class="col-md-2" role="complementary">
				<div class="hidden-print hidden-xs hidden-sm affix-top">
					<ul class="nav nav-stacked" id="sidebar">
						<li><a href="#sec0">Section 0</a>
							<ul class="nav">
								<li><a href="#sec0">Section 0a</a></li>
								<li><a href="#sec0">Section 0b</a></li>
							</ul>
						</li>
						<li><a href="#sec0">Section 1</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>

</body>
</html>
	<!-- you can set your netdata server globally, by ucommenting this -->
	<!-- you can also give a different server per chart, with the attribute: data-host="http://netdata.server:19999" -->
	<!-- <script> netdataServer = "http://box:19999"; </script> -->

	<!-- load the dashboard manager - it will do the rest -->
	<script type="text/javascript" src="dashboard.js"></script>

<script>
var options = {
	data: null,
	hostnane: 'netdata_server',
	categories: new Array(),
	categories_idx: {},
	families: new Array(),
	families_idx: {},
	chartsPerRow: 0,
	chartsMinWidth: 1450,
	chartsHeight: 150,
	sparklinesHeight: 60
}

function screenWidth() {
	return (($(window).width() * 0.95) - 50);
}

function chartsPerRow(total) {
	if(options.chartsPerRow === 0) {
		width = Math.floor(total / options.chartsMinWidth);
		if(width === 0) width = 1;
		return width;
	}
	else return options.chartsPerRow;
}

function chartsPrioritySort(a, b) {
	if(a.priority === b.priority) {
		if(a.name < b.name) return -1;
	}
	else if(a.priority < b.priority) return -1;
	return 1;
}

function uniq(array, find_key, get_result) {
	if(typeof get_result === 'undefined' || get_result === null)
		get_result = find_key;

	var idx = {};
	var result = new Array();

	$.each(array, function(i, c) {
		key = find_key(c);
		if(typeof idx[key] === 'undefined') {
			idx[key] = true;
			result.push(get_result(c));
		}
	});
	return result;
}

function uniq_with_list(array, find_key_function) {
	var idx = {};
	var result = new Array();

	$.each(array, function(i, c) {
		key = find_key_function(c);
		if(typeof idx[key] === 'undefined') {
			idx[key] = new Array();
			result.push( { name: key, values: idx[key] } );
		}
		idx[key].push(c);
	});
	result.sort(function(a, b) {
		if(a.name < b.name) return -1;
		return 1;
	});
	return result;
}

function prepareScreen(data) {
	console.log('NETDATA is paused - ready to prepare the screen');
	console.log(data);

	options.data = data;
	options.hostname = data.hostname;
	var charts = data.charts;

	$.each(charts, function(i, c) {
		if(c.enabled === true) {

			//if(c.family.length > 4 && c.family.substring(c.family.length - 4, c.family.length) === '-ifb')
			//	c.family = c.family.split('-')[0];

			// find the category of the chart
			c.category = c.type.split('.')[0];

			var tmp = c.category.split('_')[0];
			if(tmp === 'net' || tmp === 'disk')
				c.category = tmp;

			switch(c.category) {
				case 'system':
					c.category_priority = 10;
					c.category_title = 'System Summary';
					c.glyphicon = "glyphicon-dashboard";
					break;

				case 'tc':
					c.category_priority = 20;
					c.category_title = 'Quality Of Service';
					c.glyphicon = "glyphicon-random";
					break;

				case 'net':
					c.category_priority = 30;
					c.category_title = 'Network Interfaces';
					c.glyphicon = "glyphicon-transfer";
					break;

				case 'apps':
					c.category_priority = 40;
					c.category_title = 'Applications Monitoring';
					c.glyphicon = "glyphicon-tasks";
					break;

				case 'ipvs':
					c.category_priority = 50;
					c.category_title = 'IP Virtual Server';
					c.glyphicon = "glyphicon-transfer";
					break;

				case 'netfilter':
					c.category_priority = 60;
					c.category_title = 'Netfilter / IPTables';
					c.glyphicon = "glyphicon-cloud";
					break;

				case 'ipv4':
					c.category_priority = 70;
					c.category_title = 'IPv4 Summary';
					c.glyphicon = "glyphicon-globe";
					break;

				case 'mem':
					c.category_priority = 80;
					c.category_title = 'Memory';
					c.glyphicon = "glyphicon-dashboard";
					break;

				case 'cpu':
					c.category_priority = 90;
					c.category_title = 'CPUs';
					c.glyphicon = "glyphicon-dashboard";
					break;

				case 'disk':
					c.category_priority = 100;
					c.category_title = 'Disks';
					c.glyphicon = "glyphicon-hdd";
					break;

				case 'nfsd':
					c.category_priority = 110;
					c.category_title = 'NFS Server';
					c.glyphicon = "glyphicon-hdd";
					break;

				case 'squid':
					c.category_priority = 140;
					c.category_title = 'Proxy Server';
					c.glyphicon = "glyphicon-link";
					break;

				case 'netdata':
					c.category_priority = 150;
					c.category_title = 'Netdata Monitoring';
					c.glyphicon = "glyphicon-thumbs-up";
					break;

				case 'sensors':
					c.category_priority = 160;
					c.category_title = 'Hardware Sensors';
					c.glyphicon = "glyphicon-thumbs-up";
					break;

				case 'postfix':
					c.category_priority = 170;
					c.category_title = 'Mail Server';
					c.glyphicon = "glyphicon-thumbs-up";
					break;

				case 'example':
					c.category_priority = 100000;
					c.category_title = 'Example Plugins';
					c.glyphicon = "glyphicon-search";
					break;

				default:
					c.category_priority = 150;
					c.category_title = c.type;
					c.glyphicon = "glyphicon-dashboard";
					break;
			}

			// find the unique categories
			if(typeof options.categories_idx[c.category] === 'undefined') {
				options.categories_idx[c.category] = {
					charts: new Array()
				}
				options.categories.push({
					name: c.category,
					title: c.category_title,
					priority: c.category_priority,
					glyphicon: c.glyphicon,
					charts: options.categories_idx[c.category].charts
				});
			}
			options.categories_idx[c.category].charts.push(c);

			// find the unique families
			if(typeof options.families_idx[c.family] === 'undefined') {
				options.families_idx[c.family] = {
					charts: new Array()
				};
				options.families.push({
					name: c.family,
					title: c.family,
					priority: c.category_priority,
					glyphicon: c.glyphicon,
					charts: options.categories_idx[c.category].charts
				});
			}
			options.families_idx[c.family].charts.push(c);
		}
	});

	function prioritySort(a, b) {
		if(a.priority < b.priority) return -1;
		return 1;
	}

	// sort all of them
	options.categories.sort(prioritySort);
	options.families.sort(prioritySort);
	$.each(options.families,   function(i, c) { c.charts.sort(prioritySort); });

	var div = document.getElementById('charts_div');
	var pcent_width = Math.floor(100 / chartsPerRow($(div).width()));

	// find the proper duration for per-second updates
	var duration = Math.round(($(div).width() * pcent_width / 100 * data.update_every / 3) / 60) * 60;
	console.log(duration);
	var html = '';
	var sidebar = '';

	// render the charts
	$.each(options.categories, function(i, t) {
		t.charts.sort(prioritySort);

		sidebar += '<li><a href="#section' + i + '">' + t.title + '</a></li>';
		html += '<h2 id="section' + i + '">' + t.title + '</h2>';

		if(t.name === 'net') {
			var interfaces = uniq_with_list(t.charts, function(c) { return c.family; });
			console.log(interfaces);

			$.each(interfaces, function(i, c) {
				html += '<div class="netdata-group-container" id="interface_' + c.name + '" style="display: inline-block; width: ' + pcent_width.toString() + '%"><h2 class="netdata-chart-alignment">' + c.name + '</h2>';
				$.each(c.values, function(x, f) {
					if(f.type === 'net') {
						html += '<div data-netdata="' + f.id + '"'
							+ ' data-width="100%"'
							+ ' data-height="' + options.chartsHeight.toString() + 'px"'
							+ ' data-before="0"'
							+ ' data-after="-' + duration.toString() + '"'
							+ '></div>';
					}
					else {
						html += '<div data-netdata="' + f.id + '"'
							+ ' data-width="100%"'
							+ ' data-height="' + (options.chartsHeight / 2).toString() + 'px"'
							+ ' data-before="0"'
							+ ' data-after="-' + duration.toString() + '"'
							+ '></div>';
					}
				});
				html += '</div>';
			});
		}
		else if(t.name === 'disk') {
			var disks = uniq_with_list(t.charts, function(c) { return c.family; });
			console.log(disks);

			$.each(disks, function(i, c) {
				html += '<div class="netdata-group-container" id="disk_' + c.name + '" style="display: inline-block; width: ' + pcent_width.toString() + '%"><h2 class="netdata-chart-alignment">' + c.name + '</h2>';
				$.each(c.values, function(x, f) {
					var c = null;
					var h = options.chartsHeight / 2;
					switch(f.type) {
						case 'disk'        : h = options.chartsHeight; break;
						case 'disk_backlog': c = '#DD4477'; break;
						case 'disk_util'   : c = '#109618'; break;
						case 'disk_qops'   : c = '#8B0707'; break;
					}

					html += '<div data-netdata="' + f.id + '"'
						+ ' data-width="100%"'
						+ ' data-height="' + h.toString() + 'px"'
						+ ' data-before="0"'
						+ ' data-after="-' + duration.toString() + '"'
						+ ' data-colors="' + c + '"'
						+ '></div>';
				});
				html += '</div>';
			});
		}
		else {
			$.each(t.charts, function(x, c) {
				html += '<div data-netdata="' + c.id + '"'
					+ ' data-width="' + pcent_width.toString() + '%"'
					+ ' data-height="' + options.chartsHeight.toString() + 'px"'
					+ ' data-before="0"'
					+ ' data-after="-' + duration.toString() + '"'
					+ '></div>';
			});
		}

		html += '';
	});

	html += '<br/>'
	$.each(NETDATA.colors, function(i, c){
		html += '<div style="display: inline-block;"><div style="display: inline-block; width: 100px; height: 100px; background: ' + c + ';"></div><br/>' + c + '</div>';
	});

	div.innerHTML = html;
	document.getElementById('sidebar').innerHTML = sidebar;
	NETDATA.unpause();

	/* activate sidebar */
	$('#sidebar').affix({
		offset: {
			top: 200
		}
	});

	// fix for jumping to proper anchor after ajax
	$(window).load(function(){
		// Remove the # from the hash, as different browsers may or may not include it
		var hash = location.hash.replace('#','');

		if(hash != '') {
			// Clear the hash in the URL
			// location.hash = '';   // delete front "//" if you want to change the address bar
			$('html, body').animate({ scrollTop: $(location.hash).offset().top - 55}, 0);
		}
	});

	/* activate scrollspy menu */
	$(document.body).scrollspy({
		target: '#leftCol',
		offset: -55
	});
}

NETDATA.ready(function() {
	NETDATA.chartRegistry.downloadAll(NETDATA.serverDefault, function(data) {
		NETDATA.pause(function () {
			prepareScreen(data);
		});
	});
});

</script>
